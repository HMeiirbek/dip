# Отчет: Архитектура и Технологии проекта DIP

## 1. Архитектура системы

### 1.1 Общее описание

Проект реализует **защищённую голосовую коммуникационную систему с сквозным шифрованием (End-to-End Encryption, E2EE)**.

**Ключевой принцип:** голосовые данные передаются напрямую между клиентами через P2P-соединение; сервер используется только для координации сигнализации.

### 1.2 Логическая архитектура

```
┌─────────────────────────────────────────────────────────┐
│                   СИСТЕМА АРХИТЕКТУРЫ                    │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  Клиент A                              Клиент B          │
│  ┌──────────────────┐              ┌──────────────────┐  │
│  │  Браузер / PWA   │              │  Браузер / PWA   │  │
│  │  WebRTC          │─────────────▶│  WebRTC          │  │
│  │  (SRTP encrypted)│  P2P UDP     │  (SRTP encrypted)│  │
│  │  (DTLS keyexch)  │              │                  │  │
│  └────────┬─────────┘              └────────┬─────────┘  │
│           │                                  │            │
│           │      Сигнализация WebRTC        │            │
│           │    (SDP, ICE candidates)       │            │
│           └──────────────┬───────────────────┘            │
│                          │                                 │
│           ┌──────────────▼──────────────┐                 │
│           │   SIGNALING SERVER          │                 │
│           │  (NestJS + Socket.io)       │                 │
│           │  - Регистрация              │                 │
│           │  - Аутентификация           │                 │
│           │  - Оповещение о звонках      │                 │
│           │  - Релей сигнальных данных  │                 │
│           │  - Управление сессиями      │                 │
│           │                             │                 │
│           │  ┌───────────────────────┐  │                 │
│           │  │  PostgreSQL Database  │  │                 │
│           │  │  (Пользователи, звонки)  │                 │
│           │  └───────────────────────┘  │                 │
│           └─────────────────────────────┘                 │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### 1.3 Уровни системы

| Уровень | Компоненты | Назначение |
|---------|-----------|-----------|
| **Клиентский** | Браузер/PWA, WebRTC, шифрование | Захват звука, шифрование/расшифровка, установка P2P соединения |
| **Сигнализация** | NestJS, Socket.io, JWT | Регистрация, аутентификация, оповещение, релей параметров подключения |
| **Хранение** | PostgreSQL, Prisma | Хранение данных о пользователях и звонках |
| **Транспортный** | WebRTC, UDP, SRTP, DTLS | Безопасная передача голосовых данных между клиентами |

### 1.4 Граница доверия

```
┌─────────────────────────────────────────┐
│  ДОВЕРЯЕМАЯ ЗОНА                       │
│  ├─ Устройство пользователя A           │
│  ├─ Устройство пользователя B           │
│  └─ Локальные ключи шифрования          │
└─────────────────────────────────────────┘
              ↓↑ Сигнализация
┌─────────────────────────────────────────┐
│  НЕДОВЕРЯЕМАЯ ЗОНА                      │
│  ├─ Сигнализационный сервер             │
│  ├─ Сетевая инфраструктура              │
│  ├─ Интернет                            │
│  └─ Потенциальные перехватчики          │
└─────────────────────────────────────────┘
```

**Ключевой вывод:** Даже при компрометации сервера конфиденциальность голосовой коммуникации остаётся защищённой.

---

## 2. Технологический стек

### 2.1 Бэкенд

| Технология | Версия | Назначение |
|-----------|--------|-----------|
| **NestJS** | 10.0.0 | Основной фреймворк для signaling сервера |
| **TypeScript** | 5.3.0 | Язык программирования |
| **Express** | (встроенный в NestJS) | HTTP сервер |
| **Socket.io** | 4.8.0 | WebSocket коммуникация для сигнализации |
| **PostgreSQL** | 15 | База данных |
| **Prisma** | 5.22.0 | ORM для работы с БД |
| **JWT (JSON Web Tokens)** | 10.2.0 (@nestjs/jwt) | Аутентификация |
| **Passport.js** | 0.7.0 | Стратегии аутентификации |
| **Passport-JWT** | 4.0.1 | JWT стратегия |
| **bcrypt** | 5.1.1 | Хеширование паролей |
| **class-validator** | 0.14.1 | Валидация данных |
| **class-transformer** | 0.5.1 | Трансформация данных |

### 2.2 Криптография и безопасность

| Технология | Область применения |
|-----------|-------------------|
| **SRTP** (Secure Real-time Transport Protocol) | Шифрование медиа-потока (голоса) |
| **DTLS** (Datagram Transport Layer Security) | Безопасный обмен ключами сессии |
| **Ephemeral Keys** | Временные ключи, генерируемые на каждый звонок |
| **bcrypt** | Хеширование паролей на сервере |
| **JWT** | Безопасные токены аутентификации |

### 2.3 Клиентская часть

| Технология | Назначение |
|-----------|-----------|
| **WebRTC** | Одноранговая медиа-коммуникация |
| **HTML5 Media APIs** | Захват аудио с микрофона |
| **JavaScript/Web Audio API** | Обработка и кодирование звука |
| **PWA** (опционально) | Приложение в браузере |

### 2.4 Инфраструктура и развёртывание

| Технология | Назначение |
|-----------|-----------|
| **Docker** | Контейнеризация сервиса |
| **Docker Compose** | Оркестрация контейнеров (PostgreSQL + Backend) |
| **Node.js** | Runtime для NestJS |

---

## 3. Модули бэкенда

### 3.1 Структура

```
backend/
├── src/
│   ├── auth/              # Аутентификация и авторизация
│   │   ├── auth.controller.ts
│   │   ├── auth.service.ts
│   │   ├── auth.module.ts
│   │   ├── jwt-auth.guard.ts
│   │   └── jwt.strategy.ts
│   │
│   ├── users/             # Управление пользователями
│   │   ├── users.controller.ts
│   │   ├── users.service.ts
│   │   └── users.module.ts
│   │
│   ├── calls/             # Управление звонками
│   │   ├── calls.controller.ts
│   │   ├── calls.service.ts
│   │   └── calls.module.ts
│   │
│   ├── ws/                # WebSocket сигнализация
│   │   ├── ws.gateway.ts
│   │   └── ws.module.ts
│   │
│   ├── prisma/            # Слой доступа к БД
│   │   ├── prisma.module.ts
│   │   └── prisma.service.ts
│   │
│   ├── app.module.ts      # Главный модуль приложения
│   └── main.ts            # Entry point
│
├── prisma/
│   └── schema.prisma      # Схема БД
├── package.json
├── tsconfig.json
└── nest-cli.json
```

### 3.2 Ключевые модули

#### Auth Module
- Регистрация пользователей
- Вход в систему
- JWT токены
- Защита маршрутов с JWT Guard

**Сервис:**
```typescript
register(username, password)  // Создание учётной записи
login(username, password)     // Получение JWT токена
```

#### Users Module
- Получение профиля пользователя
- Получение списка всех пользователей
- Управление присутствием (online/offline)

**Сервис:**
```typescript
findById(id)   // Получить пользователя по ID
findAll()      // Получить всех пользователей
```

#### Calls Module
- Инициирование звонка
- Завершение звонка
- Управление состоянием звонка

**Сервис:**
```typescript
create(callerId, calleeId)    // Создать звонок
findById(id, userId)          // Получить звонок
end(id, userId)               // Завершить звонок
```

#### WebSocket Gateway
- Реле WebRTC предложений (offer)
- Реле WebRTC ответов (answer)
- Реле ICE кандидатов

**События:**
```typescript
@SubscribeMessage('webrtc:offer')          // SDP Offer
@SubscribeMessage('webrtc:answer')         // SDP Answer
@SubscribeMessage('webrtc:ice-candidate')  // ICE Candidate
```

---

## 4. Схема базы данных

### 4.1 Модели данных

```sql
-- Пользователи
CREATE TABLE User {
  id        UUID PRIMARY KEY DEFAULT uuid()
  username  STRING UNIQUE
  password  STRING (bcrypt hash)
  createdAt TIMESTAMP DEFAULT now()
}

-- Звонки
CREATE TABLE Call {
  id        UUID PRIMARY KEY DEFAULT uuid()
  callerId  STRING (Foreign Key → User.id)
  calleeId  STRING (Foreign Key → User.id)
  status    STRING (enum: 'created', 'ended')
  createdAt TIMESTAMP DEFAULT now()
}
```

---

## 5. Поток обработки звонка

```
┌─────────────────────────────────────────────────────────────┐
│                    ЖИЗНЕННЫЙ ЦИКЛ ЗВОНКА                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 1. АУТЕНТИФИКАЦИЯ                                             │
│    ├─ Клиент A и B регистрируются через /auth/register      │
│    └─ Получают JWT токены через /auth/login                 │
│                                                               │
│ 2. ИНИЦИИРОВАНИЕ ЗВОНКА                                      │
│    ├─ Клиент A отправляет POST /api/v1/calls                │
│    ├─ Сервер создаёт Call (status: 'created')              │
│    └─ Сервер уведомляет Клиента B через WebSocket          │
│                                                               │
│ 3. ОБМЕН СИГНАЛИЗАЦИЕЙ (WebRTC Signaling)                   │
│    ├─ Клиент A генерирует SDP Offer                         │
│    ├─ Отправляет Offer через WebSocket                      │
│    ├─ Сервер релирует Offer к Клиенту B                    │
│    ├─ Клиент B создаёт SDP Answer                           │
│    ├─ Отправляет Answer через WebSocket                     │
│    └─ Сервер релирует Answer к Клиенту A                   │
│                                                               │
│ 4. ОБМЕН ICE КАНДИДАТАМИ                                     │
│    ├─ Клиенты генерируют ICE кандидаты                      │
│    ├─ Обмениваются через WebSocket (via сервер)            │
│    └─ Находят оптимальный путь для P2P соединения           │
│                                                               │
│ 5. УСТАНОВКА P2P СОЕДИНЕНИЯ                                  │
│    ├─ DTLS handshake между клиентами                        │
│    ├─ Генерируются эфемерные ключи сессии                   │
│    └─ Соединение установлено                                 │
│                                                               │
│ 6. ПЕРЕДАЧА ЗАШИФРОВАННОГО МЕДИА                             │
│    ├─ Клиент A захватывает аудио                            │
│    ├─ Кодирует аудио (PCM → opus/other)                     │
│    ├─ Шифрует SRTP ключом сессии                            │
│    ├─ Отправляет напрямую Клиенту B (UDP)                  │
│    └─ Клиент B получает, расшифровывает, воспроизводит     │
│                                                               │
│ 7. ЗАВЕРШЕНИЕ ЗВОНКА                                         │
│    ├─ Клиент инициирует завершение                           │
│    ├─ Сервер обновляет Call (status: 'ended')               │
│    ├─ Ключи сессии удаляются на обеих клиентах             │
│    └─ P2P соединение закрывается                             │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. API Endpoints

### 6.1 Аутентификация

```
POST /api/v1/auth/register
{
  "username": "user1",
  "password": "password123"
}
→ { "id": "uuid", "username": "user1" }

POST /api/v1/auth/login
{
  "username": "user1",
  "password": "password123"
}
→ { "accessToken": "jwt-token" }
```

### 6.2 Пользователи

```
GET /api/v1/users              # Получить всех пользователей
GET /api/v1/users/:id          # Получить пользователя по ID
```

### 6.3 Звонки

```
POST /api/v1/calls
{
  "calleeId": "uuid"
}
→ { "id": "uuid", "callerId", "calleeId", "status": "created" }

GET /api/v1/calls/:id          # Получить информацию о звонке
PUT /api/v1/calls/:id/end      # Завершить звонок
```

### 6.4 WebSocket События

```
Отправка:  socket.emit('webrtc:offer', {...})
Получение: socket.on('webrtc:offer', ...)

Отправка:  socket.emit('webrtc:answer', {...})
Получение: socket.on('webrtc:answer', ...)

Отправка:  socket.emit('webrtc:ice-candidate', {...})
Получение: socket.on('webrtc:ice-candidate', ...)
```

---

## 7. Защита и криптография

### 7.1 Шифрование данных

| Уровень | Механизм | Ключи | Место хранения |
|---------|----------|-------|-----------------|
| **Голос в пути** | SRTP | Ephemeral sessionkeys | Только на клиентах |
| **Обмен ключами** | DTLS | Уникальные на каждый звонок | Не хранятся |
| **Пароли** | bcrypt (salt + hash) | Hash в БД | PostgreSQL (хеш) |
| **API Tokens** | JWT с подписью | Приватный ключ на сервере | Памя́ть сервера |

### 7.2 Функции безопасности

- ✅ **Сквозное шифрование** — голос шифруется на отправителе, расшифровывается на получателе
- ✅ **Отсутствие доступа сервера** — сервер не может получить ключи или открытый текст
- ✅ **Эфемерные ключи** — новые ключи для каждого звонка
- ✅ **Защита от перехвата** — захваченный трафик содержит только шифротекст
- ✅ **Валидация JWT** — защита API эндпоинтов
- ✅ **Хеширование паролей** — bcrypt с солью

### 7.3 Предположения безопасности

- Клиентские устройства считаются надёжными
- Сетевая инфраструктура считается враждебной
- Сервер может быть скомпрометирован
- Перехватчик может видеть весь трафик

---

## 8. Развёртывание

### 8.1 Docker Compose сервисы

```yaml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: dip
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/dip
      JWT_SECRET: (secret key)
    depends_on:
      - postgres
```

### 8.2 NPM Scripts

```bash
npm run build              # Компиляция TypeScript
npm run start              # Запуск production сервера
npm run start:dev          # Запуск с watch mode (разработка)
npm run start:debug        # Отладка
npm run prisma:generate    # Генерация Prisma client
npm run prisma:migrate     # Миграция БД
npm run prisma:studio      # Prisma Studio UI для управления БД
```

---

## 9. Документация проекта

| Документ | Путь | Содержание |
|----------|------|-----------|
| **System Architecture** | `docs/architecture/system-architecture.md` | Логическая архитектура, компоненты |
| **Backend API** | `docs/api/backend-api.md` | REST + WebSocket API endpoints |
| **Encryption Overview** | `docs/security/encryption-overview.md` | Криптографические механизмы |
| **Threat Model** | `docs/security/threat-model.md` | Угрозы, границы доверия, свойства безопасности |
| **Security Assumptions** | `docs/security/security-assumptions.md` | Предположения о безопасности |
| **Signaling Logic** | `server/signaling/signaling-logic.md` | Ответственность сервера |
| **Message Types** | `server/signaling/message-types.md` | Типы сообщений сигнализации |
| **Backend Setup** | `docs/implementation/backend-setup.md` | Инструкции по развёртыванию |

---

## Резюме

### Архитектурные решения
- **P2P архитектура** для минимизации доступа сервера к медиа
- **Отделение сигнализации от медиа** — разные каналы и протоколы
- **Недоверие к серверу** — сервер не может скомпрометировать безопасность
- **Эфемерные ключи** — невозможно восстановить прошлые разговоры

### Технологический выбор
- **NestJS** — модульная архитектура, встроенная поддержка WebSocket
- **WebRTC** — стандартизированная технология для P2P медиа
- **SRTP + DTLS** — проверенные криптографические стандарты для VoIP
- **PostgreSQL + Prisma** — простой и надёжный прием хранения метаданных
- **JWT** — stateless аутентификация масштабируемых систем
- **Docker** — простое развёртывание и воспроизведение окружения

### Сильные стороны текущей архитектуры
1. Принцип наименьшего привилегия — сервер имеет минимум полномочий
2. Разделение ответственности — каждый компонент имеет чёткую роль
3. Использование стандартов — SRTP, DTLS, WebRTC, JWT
4. Масштабируемость — stateless дизайн позволяет добавлять серверы
5. Безопасность по архитектуре — даже скомпрометированный сервер не угрожает конфиденциальности

